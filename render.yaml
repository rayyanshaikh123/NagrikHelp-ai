services:
  - type: web
    name: local-vision-server
    env: python
    plan: free
    # Use a multi-step build to prefer prebuilt wheels and install torch from
    # the PyTorch wheel index (CPU). This avoids compiling tokenizers/tokenizers
    # from source which is slow and often fails on newer Python/Rust setups.
    buildCommand: |
      set -euo pipefail
      echo "=== Build diagnostics ==="
      python --version || true
      pip --version || true
      uname -a || true
      echo "=== Upgrading pip & build tools ==="
      python -m pip install --upgrade pip setuptools wheel

      echo "=== Installing NumPy (ensure numpy<2 present before torch) ==="
      pip install --prefer-binary "numpy<2" || true

      echo "=== Installing PyTorch from PyTorch wheel index ==="
      # Install torch (no fixed +cpu suffix) from PyTorch index so a
      # compatible manylinux wheel is selected for the build environment.
      pip install --prefer-binary --extra-index-url https://download.pytorch.org/whl/cpu "torch" || true

      echo "=== Installing remaining requirements (prefer binary wheels) ==="
      pip install --prefer-binary --extra-index-url https://download.pytorch.org/whl/cpu -r local_vision_requirements.txt

      echo "=== Build finished ==="
    startCommand: uvicorn local_vision_server:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: MODEL_NAME
        value: "google/vit-base-patch16-224"
      - key: TOP_K
        value: "5"
      # Render provides $PORT at runtime; LOCAL_VISION_HOST is left as default in code
    healthCheckPath: /
