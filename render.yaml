services:
  - type: web
    name: nagrikhelp-ai-server
    env: python
    plan: free
    # Optimized build for headless deployment with opencv-python-headless
    # Build v2: Force clear cache and use new requirements.txt
    buildCommand: |
      set -euo pipefail
      echo "=== Build diagnostics ==="
      python --version || true
      pip --version || true
      uname -a || true
      
      echo "=== Upgrading pip & build tools ==="
      python -m pip install --upgrade pip setuptools wheel

      echo "=== Uninstalling old opencv-python (if present) ==="
      pip uninstall -y opencv-python opencv-contrib-python || true

      echo "=== Installing dependencies from requirements.txt ==="
      # Using requirements.txt with opencv-python-headless for headless environments
      pip install --no-cache-dir --prefer-binary --extra-index-url https://download.pytorch.org/whl/cpu -r requirements.txt

      echo "=== Verifying opencv installation ==="
      python -c "import cv2; print(f'OpenCV version: {cv2.__version__}')" || true

      echo "=== Build finished ==="
      
    startCommand: uvicorn local_vision_server:app --host 0.0.0.0 --port $PORT
    
    envVars:
      # AI Validation Configuration
      - key: CONFIDENCE_THRESHOLD
        value: "0.45"
      - key: ENABLE_YOLO
        value: "true"
      - key: ENABLE_CLIP
        value: "true"
      - key: TOP_K
        value: "5"
      # Hugging Face token for private models (optional)
      - key: HUGGINGFACE_HUB_TOKEN
        value: ""
        
    healthCheckPath: /
